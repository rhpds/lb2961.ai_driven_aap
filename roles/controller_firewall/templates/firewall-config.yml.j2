---
- name: Run playbook for {{ controller_firewall_hostname }}
  hosts: aap_controller
  vars:
    cloud_provider: openshift_cnv
  tasks:
    - name: Configure firewall on controller VM
      when: 'cloud_provider == "{{ cloud_provider }}"'
      delegate_to: "{{ controller_firewall_hostname }}"
      block:
        - name: Ensure firewalld is installed
          ansible.builtin.package:
            name: firewalld
            state: present
          become: true

        - name: Ensure firewalld is running and enabled
          ansible.builtin.systemd:
            name: firewalld
            state: started
            enabled: true
          become: true

        - name: Open port 5000/tcp for EDA webhook listener
          ansible.posix.firewalld:
            port: 5000/tcp
            zone: public
            permanent: true
            immediate: true
            state: enabled
          become: true

        - name: Verify port 5000 is open
          ansible.builtin.command: firewall-cmd --list-ports
          register: firewall_ports
          changed_when: false
          become: true

        - name: Display open firewall ports
          ansible.builtin.debug:
            msg: "Controller firewall ports: {% raw %}{{ firewall_ports.stdout }}{% endraw %}"
        
        - name: Copy port numbers
          ansible.builtin.copy:
            content: "{% raw %}{{ firewall_ports.stdout }}{% endraw %}"
            dest: /tmp/ports.txt
